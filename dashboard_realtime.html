<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WellTegra - Real-Time Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Arial, sans-serif; 
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 100%); 
            color: #e0e0e0; 
            min-height: 100vh;
        }
        .header { 
            background: rgba(22, 33, 62, 0.9); 
            padding: 20px; 
            border-bottom: 2px solid #00d4ff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { color: #00d4ff; font-size: 1.8em; }
        .live-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #4ecca3;
        }
        .live-dot {
            width: 12px;
            height: 12px;
            background: #4ecca3;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            background: linear-gradient(145deg, #16213e, #1a2744);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid rgba(0, 212, 255, 0.2);
            transition: transform 0.3s;
        }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-value { font-size: 2.5em; font-weight: bold; color: #00d4ff; }
        .stat-label { color: #888; margin-top: 10px; }
        .critical .stat-value { color: #ff6b6b; }
        .warning .stat-value { color: #ffd93d; }
        .success .stat-value { color: #4ecca3; }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .chart-card {
            background: #16213e;
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(0, 212, 255, 0.1);
        }
        .chart-card h3 { color: #00d4ff; margin-bottom: 15px; }
        .chart-container { height: 250px; }
        
        .table-section {
            background: #16213e;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            overflow-x: auto;
        }
        .table-section h3 { color: #00d4ff; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #333; }
        th { background: #0f3460; color: #00d4ff; position: sticky; top: 0; }
        tr:hover { background: rgba(0, 212, 255, 0.05); }
        
        .risk-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
        }
        .risk-critical { background: rgba(255, 107, 107, 0.2); color: #ff6b6b; }
        .risk-high { background: rgba(255, 217, 61, 0.2); color: #ffd93d; }
        .risk-medium { background: rgba(0, 212, 255, 0.2); color: #00d4ff; }
        .risk-low { background: rgba(78, 204, 163, 0.2); color: #4ecca3; }
        
        .alert-bar {
            background: rgba(255, 107, 107, 0.1);
            border-left: 4px solid #ff6b6b;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 10px 10px 0;
        }
        .alert-bar.hidden { display: none; }
        
        .footer {
            text-align: center;
            padding: 30px;
            color: #666;
            border-top: 1px solid #333;
            margin-top: 40px;
        }
        
        .refresh-info {
            font-size: 0.9em;
            color: #666;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>üîç WellTegra Brahan Scanner</h1>
            <div class="refresh-info">Last updated: <span id="lastUpdate">Loading...</span></div>
        </div>
        <div class="live-indicator">
            <div class="live-dot"></div>
            <span>LIVE</span>
        </div>
    </div>
    
    <div class="container">
        <div class="alert-bar" id="alertBar">
            <strong>‚ö†Ô∏è Alert:</strong> <span id="alertText">Loading...</span>
        </div>
        
        <div class="stats-grid" id="statsGrid">
            <!-- Stats loaded dynamically -->
        </div>
        
        <div class="charts-grid">
            <div class="chart-card">
                <h3>üìä Risk Distribution</h3>
                <div class="chart-container">
                    <canvas id="riskChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3>üìà Failure Probability</h3>
                <div class="chart-container">
                    <canvas id="probabilityChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="table-section">
            <h3>üõ¢Ô∏è Well Risk Assessment</h3>
            <table id="wellsTable">
                <thead>
                    <tr>
                        <th>Well</th>
                        <th>Risk Score</th>
                        <th>Level</th>
                        <th>Failure Prob.</th>
                        <th>Factors</th>
                        <th>Recommendation</th>
                    </tr>
                </thead>
                <tbody id="wellsBody">
                    <!-- Rows loaded dynamically -->
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="footer">
        <p>WellTegra Brahan Forensic Engine v3.0</p>
        <p>Real-time monitoring ‚Ä¢ ML predictions ‚Ä¢ 20 capabilities</p>
    </div>

    <script>
        // Configuration
        const API_BASE = 'http://localhost:5000/api';
        const REFRESH_INTERVAL = 30000; // 30 seconds
        
        // Initialize charts
        let riskChart, probabilityChart;
        
        function initCharts() {
            // Risk Distribution Chart
            const riskCtx = document.getElementById('riskChart').getContext('2d');
            riskChart = new Chart(riskCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Critical', 'High', 'Medium', 'Low'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: ['#ff6b6b', '#ffd93d', '#00d4ff', '#4ecca3']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { color: '#888' } }
                    }
                }
            });
            
            // Probability Chart
            const probCtx = document.getElementById('probabilityChart').getContext('2d');
            probabilityChart = new Chart(probCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Failure Probability %',
                        data: [],
                        backgroundColor: '#00d4ff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 100, ticks: { color: '#888' } },
                        x: { ticks: { color: '#888' } }
                    }
                }
            });
        }
        
        // Fetch data from API
        async function fetchData() {
            try {
                const [summaryRes, riskRes] = await Promise.all([
                    fetch(`${API_BASE}/summary`),
                    fetch(`${API_BASE}/risk-scores`)
                ]);
                
                const summary = await summaryRes.json();
                const risk = await riskRes.json();
                
                updateDashboard(summary, risk);
            } catch (error) {
                console.error('Error fetching data:', error);
                loadLocalData();
            }
        }
        
        // Load local JSON files as fallback
        async function loadLocalData() {
            try {
                const risk = await fetch('risk_scores.json').then(r => r.json());
                updateDashboard({
                    total_wells: Object.keys(risk).length,
                    critical: Object.values(risk).filter(v => v.level === 'CRITICAL').length,
                    high_risk: Object.values(risk).filter(v => v.level === 'HIGH').length,
                    medium_risk: Object.values(risk).filter(v => v.level === 'MEDIUM').length,
                    low_risk: Object.values(risk).filter(v => v.level === 'LOW').length
                }, risk);
            } catch (e) {
                console.error('Error loading local data:', e);
            }
        }
        
        // Update dashboard
        function updateDashboard(summary, risk) {
            // Update timestamp
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            
            // Update stats
            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card critical">
                    <div class="stat-value">${summary.critical || 0}</div>
                    <div class="stat-label">Critical Risk</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-value">${summary.high_risk || 0}</div>
                    <div class="stat-label">High Risk</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${summary.medium_risk || 0}</div>
                    <div class="stat-label">Medium Risk</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-value">${summary.low_risk || 0}</div>
                    <div class="stat-label">Low Risk</div>
                </div>
            `;
            
            // Update alert
            if (summary.critical > 0) {
                document.getElementById('alertBar').classList.remove('hidden');
                document.getElementById('alertText').textContent = 
                    `${summary.critical} wells have CRITICAL risk level requiring immediate attention`;
            } else {
                document.getElementById('alertBar').classList.add('hidden');
            }
            
            // Update risk chart
            riskChart.data.datasets[0].data = [
                summary.critical || 0,
                summary.high_risk || 0,
                summary.medium_risk || 0,
                summary.low_risk || 0
            ];
            riskChart.update();
            
            // Update probability chart
            const wells = Object.entries(risk)
                .sort((a, b) => b[1].score - a[1].score)
                .slice(0, 10);
            
            probabilityChart.data.labels = wells.map(w => w[0].substring(0, 15);
            probabilityChart.data.datasets[0].data = wells.map(w => w[1].score);
            probabilityChart.update();
            
            // Update table
            const tbody = document.getElementById('wellsBody');
            tbody.innerHTML = Object.entries(risk)
                .sort((a, b) => b[1].score - a[1].score)
                .map(([well, data]) => `
                    <tr>
                        <td>${well}</td>
                        <td>${data.score}</td>
                        <td><span class="risk-badge risk-${data.level.toLowerCase()}">${data.level}</span></td>
                        <td>${data.score}%</td>
                        <td>${(data.factors || []).join(', ')}</td>
                        <td>${getRecommendation(data.level)}</td>
                    </tr>
                `).join('');
        }
        
        function getRecommendation(level) {
            switch(level) {
                case 'CRITICAL': return 'Immediate intervention';
                case 'HIGH': return 'Inspect within 30 days';
                case 'MEDIUM': return 'Next maintenance cycle';
                default: return 'Routine monitoring';
            }
        }
        
        // Initialize
        initCharts();
        fetchData();
        
        // Auto-refresh
        setInterval(fetchData, REFRESH_INTERVAL);
    </script>
</body>
</html>
